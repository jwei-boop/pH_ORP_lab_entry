<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lab Data Entry - pH/ORP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a73e8;
            --success: #0d9488;
            --danger: #dc2626;
            --warning: #ea580c;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 15px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        button, .button {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #0f766e;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            background: #1557b0;
        }

        #imagePreview {
            margin-top: 16px;
            border-radius: 8px;
            max-width: 100%;
            height: auto;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            -webkit-user-select: text; /* Allow text selection on iOS */
            user-select: text;
        }

        #ocrResult {
            margin-top: 16px;
            padding: 16px;
            background: #f1f5f9;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 14px;
        }

        thead {
            background: #f8fafc;
            position: sticky;
            top: 0;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
        }

        td input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        td input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .delete-btn {
            padding: 6px 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .info-box {
            background: #e0f2fe;
            border: 2px solid #0ea5e9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .info-box strong {
            color: #075985;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Lab Data Entry</h1>
        <div class="subtitle">pH & ORP Measurements - CSV Export</div>
    </div>

    <div class="card">
        <div class="info-box">
            <strong>üìÅ Workflow:</strong> Parse data ‚Üí Export CSV ‚Üí Save to Google Drive folder ‚Üí Auto-imported by Apps Script
        </div>
    </div>

    <!-- Step 1: Upload Photo -->
    <div class="card">
        <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">Upload Notebook Photo</div>
        </div>
        <div>
            <input type="file" id="fileInput" accept="image/*" capture="environment">
            <label for="fileInput" class="file-input-label">
                üì∏ Take Photo / Choose from Library
            </label>
            <img id="imagePreview" alt="Notebook photo - long-press to use Live Text">
            <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; display: none;" id="imageHelp">
                <strong>üì± How to use Live Text:</strong><br>
                1. Long-press directly on the photo above<br>
                2. Text will become selectable<br>
                3. Tap "Select All" or manually select measurements<br>
                4. Tap "Copy"<br>
                5. Then click "Parse Data" button below
            </div>
            <div id="ocrResult"></div>
            <div id="uploadStatus" class="status"></div>
        </div>
    </div>

    <!-- Step 2: Parse Data -->
    <div class="card hidden" id="parseCard">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">Parse & Review Data</div>
        </div>
        <div>
            <p style="margin-bottom: 12px; color: var(--text-secondary);">Use iPad Live Text to copy measurements from the image, then click Parse.</p>
            <div class="button-group">
                <button id="parseButton" class="btn-primary">
                    üîÑ Parse Data
                </button>
                <button id="addRowButton" class="btn-secondary">
                    ‚ûï Add Row Manually
                </button>
            </div>
            <div id="parseStatus" class="status"></div>
        </div>
    </div>

    <!-- Step 3: Review Table -->
    <div class="card hidden" id="tableCard">
        <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">Review & Export</div>
        </div>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Ore</th>
                        <th>Test Type</th>
                        <th>Flask #</th>
                        <th>pH</th>
                        <th>ORP</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        <div class="button-group" style="margin-top: 20px;">
            <button id="exportButton" class="btn-success">
                üíæ Export CSV to Drive
            </button>
            <button id="clearButton" class="btn-danger">
                üóëÔ∏è Clear All
            </button>
        </div>
        <div id="exportStatus" class="status"></div>
    </div>

    <script>
        // DOM Elements
        const elements = {
            fileInput: document.getElementById('fileInput'),
            imagePreview: document.getElementById('imagePreview'),
            ocrResult: document.getElementById('ocrResult'),
            parseCard: document.getElementById('parseCard'),
            tableCard: document.getElementById('tableCard'),
            parseButton: document.getElementById('parseButton'),
            addRowButton: document.getElementById('addRowButton'),
            exportButton: document.getElementById('exportButton'),
            clearButton: document.getElementById('clearButton'),
            tableBody: document.getElementById('tableBody'),
            uploadStatus: document.getElementById('uploadStatus'),
            parseStatus: document.getElementById('parseStatus'),
            exportStatus: document.getElementById('exportStatus')
        };

        let parsedData = [];

        // File Upload & OCR
        elements.fileInput.addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate it's an image
            if (!file.type.startsWith('image/')) {
                showStatus(elements.uploadStatus, 'error', 'Please select an image file.');
                return;
            }

            showStatus(elements.uploadStatus, 'info', 'Loading image...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Create image element to ensure it loads
                const img = new Image();
                img.onload = function() {
                    elements.imagePreview.src = e.target.result;
                    elements.imagePreview.style.display = 'block';
                    elements.imagePreview.style.maxWidth = '100%';
                    elements.imagePreview.style.height = 'auto';
                    
                    // Show help text
                    document.getElementById('imageHelp').style.display = 'block';
                    
                    showStatus(elements.uploadStatus, 'success', '‚úì Image loaded! Long-press on the photo below to use Live Text and copy your measurements.');
                    elements.parseCard.classList.remove('hidden');
                };
                img.onerror = function() {
                    showStatus(elements.uploadStatus, 'error', 'Failed to load image. Please try again.');
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                showStatus(elements.uploadStatus, 'error', 'Failed to read file. Please try again.');
            };
            reader.readAsDataURL(file);
        }

        // Parsing Logic
        elements.parseButton.addEventListener('click', parseData);

        function parseData() {
            const ocrText = prompt('Paste the text you copied from the image using Live Text:');
            if (!ocrText) return;

            elements.ocrResult.textContent = ocrText;
            elements.ocrResult.style.display = 'block';

            showStatus(elements.parseStatus, 'info', 'Parsing data...');

            try {
                parsedData = parseNotebookData(ocrText);
                
                if (parsedData.length === 0) {
                    showStatus(elements.parseStatus, 'error', 'No valid data found. Please check the format.');
                    return;
                }

                renderTable();
                elements.tableCard.classList.remove('hidden');
                showStatus(elements.parseStatus, 'success', `‚úì Successfully parsed ${parsedData.length} measurements`);
            } catch (error) {
                showStatus(elements.parseStatus, 'error', 'Error parsing data: ' + error.message);
            }
        }

        function parseNotebookData(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const results = [];
            let currentExperiment = null;

            for (const line of lines) {
                // Skip horizontal lines
                if (line.match(/^[-_=]+$/)) continue;

                // Try to parse experiment tag
                // Matches: P4-02/WT, P999/03/KT, P4-02 WT, etc.
                const tagMatch = line.match(/([A-Z]\d+)[-\s/]*(\d+)?[-\s/]*(WT|KT|AT|BT)/i);
                if (tagMatch) {
                    currentExperiment = {
                        project: tagMatch[1],
                        ore: tagMatch[2] || '',
                        testType: tagMatch[3].toUpperCase()
                    };
                    continue;
                }

                // Try to parse measurement line (pH ORP Flask)
                // Matches various formats: "3.54 312 F1", "3.54 312 F1", etc.
                const measureMatch = line.match(/(\d+\.?\d*)\s+(\d+)\s+F(\d+)/i);
                if (measureMatch && currentExperiment) {
                    results.push({
                        project: currentExperiment.project,
                        ore: currentExperiment.ore,
                        testType: currentExperiment.testType,
                        flask: measureMatch[3],
                        pH: measureMatch[1],
                        orp: measureMatch[2]
                    });
                }
            }

            return results;
        }

        // Table Rendering
        function renderTable() {
            elements.tableBody.innerHTML = '';
            
            parsedData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.project}" data-index="${index}" data-field="project"></td>
                    <td><input type="text" value="${row.ore}" data-index="${index}" data-field="ore"></td>
                    <td><input type="text" value="${row.testType}" data-index="${index}" data-field="testType"></td>
                    <td><input type="text" value="${row.flask}" data-index="${index}" data-field="flask"></td>
                    <td><input type="number" step="0.01" value="${row.pH}" data-index="${index}" data-field="pH"></td>
                    <td><input type="number" value="${row.orp}" data-index="${index}" data-field="orp"></td>
                    <td><button class="delete-btn" onclick="deleteRow(${index})">Delete</button></td>
                `;
                elements.tableBody.appendChild(tr);
            });

            // Add event listeners for editing
            document.querySelectorAll('#tableBody input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    parsedData[index][field] = this.value;
                });
            });
        }

        window.deleteRow = function(index) {
            parsedData.splice(index, 1);
            renderTable();
            if (parsedData.length === 0) {
                elements.tableCard.classList.add('hidden');
            }
        };

        elements.addRowButton.addEventListener('click', () => {
            parsedData.push({
                project: '',
                ore: '',
                testType: '',
                flask: '',
                pH: '',
                orp: ''
            });
            renderTable();
            elements.tableCard.classList.remove('hidden');
        });

        // Export to CSV
        elements.exportButton.addEventListener('click', exportToCSV);

        function exportToCSV() {
            if (parsedData.length === 0) {
                showStatus(elements.exportStatus, 'error', 'No data to export!');
                return;
            }

            showStatus(elements.exportStatus, 'info', 'Generating CSV...');

            try {
                const timestamp = new Date().toISOString();
                const rows = parsedData.map(row => formatRowForCSV(row, timestamp));
                
                // Create CSV content
                const headers = [
                    'Timestamp', 'Test Type', 'Project', 'Ore',
                    'WT pH', 'AT pH', 'BT pH', 'KT pH',
                    'KT Volume Acid Added', 'KT pH Adjusted',
                    'AT Flask Number', 'BT Flask Number', 'WT Flask Number', 'KT Flask Number',
                    'AT ORP', 'BT ORP', 'WT ORP', 'KT ORP'
                ];
                
                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });

                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const filename = `Lab_Data_${new Date().toISOString().split('T')[0]}_${Date.now()}.csv`;
                
                // Trigger download
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                showStatus(elements.exportStatus, 'success', `‚úì CSV exported! Save it to your Google Drive folder. (${parsedData.length} measurements)`);
                
                // Optional: Clear data after export
                setTimeout(() => {
                    if (confirm('Data exported successfully! Clear the form for next batch?')) {
                        parsedData = [];
                        renderTable();
                        elements.tableCard.classList.add('hidden');
                        elements.parseCard.classList.add('hidden');
                        elements.imagePreview.style.display = 'none';
                        elements.ocrResult.style.display = 'none';
                        elements.fileInput.value = '';
                    }
                }, 1000);

            } catch (error) {
                showStatus(elements.exportStatus, 'error', 'Export failed: ' + error.message);
            }
        }

        function formatRowForCSV(row, timestamp) {
            // Column order matches your sheet
            const baseRow = [
                timestamp,
                row.testType,
                row.project,
                row.ore,
                '', // WT pH
                '', // AT pH
                '', // BT pH
                '', // KT pH
                '', // KT Volume Acid Added
                '', // KT pH Adjusted
                '', // AT Flask Number
                '', // BT Flask Number
                '', // WT Flask Number
                '', // KT Flask Number
                '', // AT ORP
                '', // BT ORP
                '', // WT ORP
                ''  // KT ORP
            ];

            // Fill in the appropriate columns based on test type
            switch (row.testType) {
                case 'WT':
                    baseRow[4] = row.pH;      // WT pH
                    baseRow[12] = row.flask;  // WT Flask Number
                    baseRow[16] = row.orp;    // WT ORP
                    break;
                case 'AT':
                    baseRow[5] = row.pH;      // AT pH
                    baseRow[10] = row.flask;  // AT Flask Number
                    baseRow[14] = row.orp;    // AT ORP
                    break;
                case 'BT':
                    baseRow[6] = row.pH;      // BT pH
                    baseRow[11] = row.flask;  // BT Flask Number
                    baseRow[15] = row.orp;    // BT ORP
                    break;
                case 'KT':
                    baseRow[7] = row.pH;      // KT pH
                    baseRow[13] = row.flask;  // KT Flask Number
                    baseRow[17] = row.orp;    // KT ORP
                    break;
            }

            return baseRow;
        }

        elements.clearButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all data?')) {
                parsedData = [];
                renderTable();
                elements.tableCard.classList.add('hidden');
            }
        });

        // Helper Functions
        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
