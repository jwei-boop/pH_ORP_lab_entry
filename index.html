<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>pH/ORP Lab Data Entry</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #1d1d1f;
            font-size: 32px;
            margin-bottom: 10px;
        }

        h2 {
            color: #1d1d1f;
            font-size: 24px;
            margin-bottom: 20px;
            margin-top: 30px;
        }

        .subtitle {
            color: #86868b;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e5e7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #86868b;
            transition: all 0.3s;
        }

        .step.active {
            background: #007aff;
            color: white;
        }

        .step.completed {
            background: #34c759;
            color: white;
        }

        /* Experiment Selection */
        .experiment-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .experiment-item {
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .experiment-item:active {
            transform: scale(0.98);
        }

        .experiment-item.selected {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .experiment-checkbox {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border: 2px solid #c7c7cc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .experiment-item.selected .experiment-checkbox {
            background: #007aff;
            border-color: #007aff;
        }

        .experiment-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .experiment-item.selected .experiment-checkbox::after {
            opacity: 1;
        }

        .experiment-details {
            flex: 1;
        }

        .experiment-name {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .experiment-meta {
            font-size: 14px;
            color: #86868b;
        }

        /* Flask Selection */
        .flask-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .flask-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        .flask-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }

        .flask-item {
            aspect-ratio: 1;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .flask-item:active {
            transform: scale(0.95);
        }

        .flask-item.selected {
            background: #007aff;
            border-color: #007aff;
            color: white;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e5e5e7;
            color: #1d1d1f;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e5e7;
            border-top-color: #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Select All Button */
        .select-all-btn {
            padding: 12px 20px;
            background: #f0f7ff;
            border: 2px solid #007aff;
            color: #007aff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
        }

        .select-all-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- File Upload State -->
        <div id="uploadState">
            <h1>pH/ORP Lab Data Entry</h1>
            <p class="subtitle">Select your experiment list CSV file to begin</p>
            
            <div style="text-align: center; padding: 40px 0;">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button class="btn btn-primary" id="uploadBtn" style="width: 100%; max-width: 400px; margin: 0 auto;">
                    üìÅ Select CSV File
                </button>
                <p style="margin-top: 20px; color: #86868b; font-size: 14px;">
                    Download master_experiment_list.csv from Google Drive to your iPad, then select it here
                </p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Loading experiments...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden error">
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>

        <!-- Step 1: Experiment Selection -->
        <div id="step1" class="hidden">
            <h1>Session Setup</h1>
            <p class="subtitle">Select which experiments you're measuring today</p>
            
            <div class="step-indicator">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
            </div>

            <div id="experimentList" class="experiment-list"></div>

            <div class="button-group">
                <button class="btn btn-primary" id="continueToFlasks" disabled>
                    Continue to Flask Selection
                </button>
            </div>
        </div>

        <!-- Step 2: Flask Selection -->
        <div id="step2" class="hidden">
            <h1>Flask Selection</h1>
            <p class="subtitle">Select which flasks to measure for each experiment</p>
            
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step active">2</div>
                <div class="step">3</div>
            </div>

            <div id="flaskSections"></div>

            <div class="button-group">
                <button class="btn btn-secondary" id="backToExperiments">Back</button>
                <button class="btn btn-primary" id="startMeasurements" disabled>
                    Start Measurements
                </button>
            </div>
        </div>

        <!-- Step 3: Measurements (placeholder for now) -->
        <div id="step3" class="hidden">
            <h1>Measurements</h1>
            <p class="subtitle">Enter pH and ORP values</p>
            
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step completed">2</div>
                <div class="step active">3</div>
            </div>

            <p style="padding: 40px 0; text-align: center; color: #86868b;">
                Measurement entry screen coming next...
            </p>

            <div class="button-group">
                <button class="btn btn-secondary" id="backToFlasks">Back</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let experiments = [];
        let selectedExperiments = [];
        let flaskSelections = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Set up file upload handler
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('csvFileInput').click();
            });
            
            document.getElementById('csvFileInput').addEventListener('change', handleFileSelect);
        }

        // Handle file selection
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showError('Please select a CSV file');
                return;
            }
            
            try {
                document.getElementById('uploadState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('hidden');
                
                const csvText = await file.text();
                parseCSV(csvText);
                showStep(1);
            } catch (error) {
                showError('Failed to read file: ' + error.message);
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            
            experiments = lines.slice(1)
                .filter(line => line.trim()) // Skip empty lines
                .map(line => {
                    const values = line.split(',');
                    const exp = {
                        project: values[0],
                        ore: values[1],
                        testType: values[2],
                        flaskCount: parseInt(values[3]) || 0,
                        daysSince: parseInt(values[4]) || 999,
                        flasks: []
                    };
                    
                    // Get all flask values from remaining columns
                    for (let i = 5; i < values.length; i++) {
                        if (values[i] && values[i].trim()) {
                            exp.flasks.push(values[i].trim());
                        }
                    }
                    
                    return exp;
                });
            
            console.log('Loaded experiments:', experiments);
        }

        // Show specific step
        function showStep(step) {
            document.getElementById('uploadState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            
            if (step === 1) {
                renderExperimentList();
                document.getElementById('step1').classList.remove('hidden');
            } else if (step === 2) {
                renderFlaskSelection();
                document.getElementById('step2').classList.remove('hidden');
            } else if (step === 3) {
                document.getElementById('step3').classList.remove('hidden');
            }
        }

        // Render experiment selection list
        function renderExperimentList() {
            const container = document.getElementById('experimentList');
            container.innerHTML = '';
            
            experiments.forEach((exp, index) => {
                const item = document.createElement('div');
                item.className = 'experiment-item';
                item.innerHTML = `
                    <div class="experiment-checkbox"></div>
                    <div class="experiment-details">
                        <div class="experiment-name">
                            ${exp.project} - Ore ${exp.ore} - ${exp.testType}
                        </div>
                        <div class="experiment-meta">
                            ${exp.flaskCount} flasks ‚Ä¢ Measured ${exp.daysSince} days ago
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => toggleExperiment(index, item));
                container.appendChild(item);
            });
        }

        // Toggle experiment selection
        function toggleExperiment(index, element) {
            const exp = experiments[index];
            const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
            
            const selectedIndex = selectedExperiments.findIndex(e => 
                `${e.project}_${e.ore}_${e.testType}` === expId
            );
            
            if (selectedIndex >= 0) {
                selectedExperiments.splice(selectedIndex, 1);
                element.classList.remove('selected');
            } else {
                selectedExperiments.push(exp);
                element.classList.add('selected');
            }
            
            document.getElementById('continueToFlasks').disabled = selectedExperiments.length === 0;
        }

        // Render flask selection
        function renderFlaskSelection() {
            const container = document.getElementById('flaskSections');
            container.innerHTML = '';
            
            selectedExperiments.forEach(exp => {
                const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
                
                const section = document.createElement('div');
                section.className = 'flask-section';
                
                const title = document.createElement('div');
                title.className = 'flask-section-title';
                title.textContent = `${exp.project} - Ore ${exp.ore} - ${exp.testType}`;
                section.appendChild(title);
                
                // Select All button
                const selectAllBtn = document.createElement('button');
                selectAllBtn.className = 'select-all-btn';
                selectAllBtn.textContent = 'Select All Flasks';
                selectAllBtn.addEventListener('click', () => selectAllFlasks(expId, exp.flasks));
                section.appendChild(selectAllBtn);
                
                const grid = document.createElement('div');
                grid.className = 'flask-grid';
                grid.id = `flask-grid-${expId}`;
                
                exp.flasks.forEach(flask => {
                    const flaskItem = document.createElement('div');
                    flaskItem.className = 'flask-item';
                    flaskItem.textContent = flask;
                    flaskItem.dataset.flask = flask;
                    flaskItem.dataset.expId = expId;
                    
                    flaskItem.addEventListener('click', () => toggleFlask(expId, flask, flaskItem));
                    grid.appendChild(flaskItem);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // Toggle flask selection
        function toggleFlask(expId, flask, element) {
            if (!flaskSelections[expId]) {
                flaskSelections[expId] = [];
            }
            
            const index = flaskSelections[expId].indexOf(flask);
            if (index >= 0) {
                flaskSelections[expId].splice(index, 1);
                element.classList.remove('selected');
            } else {
                flaskSelections[expId].push(flask);
                element.classList.add('selected');
            }
            
            updateStartButton();
        }

        // Select all flasks for an experiment
        function selectAllFlasks(expId, flasks) {
            flaskSelections[expId] = [...flasks];
            
            const grid = document.getElementById(`flask-grid-${expId}`);
            Array.from(grid.children).forEach(item => {
                item.classList.add('selected');
            });
            
            updateStartButton();
        }

        // Update start button state
        function updateStartButton() {
            const hasSelections = Object.values(flaskSelections).some(arr => arr.length > 0);
            document.getElementById('startMeasurements').disabled = !hasSelections;
        }

        // Show error
        function showError(message) {
            document.getElementById('uploadState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
            
            // Show upload button again after error
            setTimeout(() => {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('uploadState').classList.remove('hidden');
            }, 3000);
        }

        // Button handlers
        document.getElementById('continueToFlasks').addEventListener('click', () => showStep(2));
        document.getElementById('backToExperiments').addEventListener('click', () => showStep(1));
        document.getElementById('startMeasurements').addEventListener('click', () => {
            console.log('Selected experiments:', selectedExperiments);
            console.log('Flask selections:', flaskSelections);
            showStep(3);
        });
        document.getElementById('backToFlasks').addEventListener('click', () => showStep(2));
    </script>
</body>
</html>
