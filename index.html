<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>pH/ORP Lab Data Entry</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #1d1d1f;
            font-size: 32px;
            margin-bottom: 10px;
        }

        h2 {
            color: #1d1d1f;
            font-size: 24px;
            margin-bottom: 20px;
            margin-top: 30px;
        }

        .subtitle {
            color: #86868b;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e5e7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #86868b;
            transition: all 0.3s;
        }

        .step.active {
            background: #007aff;
            color: white;
        }

        .step.completed {
            background: #34c759;
            color: white;
        }

        /* Experiment Selection */
        .experiment-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .experiment-item {
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .experiment-item:active {
            transform: scale(0.98);
        }

        .experiment-item.selected {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .experiment-checkbox {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border: 2px solid #c7c7cc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .experiment-item.selected .experiment-checkbox {
            background: #007aff;
            border-color: #007aff;
        }

        .experiment-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .experiment-item.selected .experiment-checkbox::after {
            opacity: 1;
        }

        .experiment-details {
            flex: 1;
        }

        .experiment-name {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .experiment-meta {
            font-size: 14px;
            color: #86868b;
        }

        /* Flask Selection */
        .flask-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .flask-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        .flask-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }

        .flask-item {
            aspect-ratio: 1;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .flask-item:active {
            transform: scale(0.95);
        }

        .flask-item.selected {
            background: #007aff;
            border-color: #007aff;
            color: white;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e5e5e7;
            color: #1d1d1f;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e5e7;
            border-top-color: #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Select All Button */
        .select-all-btn {
            padding: 12px 20px;
            background: #f0f7ff;
            border: 2px solid #007aff;
            color: #007aff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
        }

        .select-all-btn:active {
            transform: scale(0.98);
        }

        /* Measurement Screen - Dual Probe Layout */
        .probe-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .probe-container {
                grid-template-columns: 1fr;
            }
        }

        .probe-box {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e5e5e7;
        }

        .probe-box.active {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .probe-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .probe-header h3 {
            font-size: 20px;
            color: #1d1d1f;
            margin: 0;
        }

        .probe-experiment-select,
        .probe-flask-select {
            margin-bottom: 15px;
        }

        .probe-experiment-select label,
        .probe-flask-select label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .experiment-dropdown,
        .flask-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .experiment-dropdown:disabled,
        .flask-dropdown:disabled {
            background: #f5f5f7;
            cursor: not-allowed;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .progress-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff3b30;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .progress-dot.completed {
            background: #34c759;
        }

        /* Value Input Box */
        .value-input-box {
            background: white;
            border: 3px solid #e5e5e7;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .value-input-box:active {
            transform: scale(0.98);
        }

        .value-input-box.active {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .value-display {
            font-size: 36px;
            font-weight: 600;
            color: #1d1d1f;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .value-display.placeholder {
            color: #86868b;
            font-size: 18px;
        }

        .save-btn {
            width: 100%;
        }

        /* Number Pad */
        .number-pad {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e5e7;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .number-pad-display {
            background: #f9f9f9;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            padding: 20px;
            font-size: 32px;
            font-weight: 600;
            text-align: right;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .number-pad-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .num-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .num-btn:active {
            transform: scale(0.95);
            background: #f0f7ff;
            border-color: #007aff;
        }

        .delete-btn {
            background: #ff3b30;
            color: white;
            border-color: #ff3b30;
        }

        .number-pad-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- File Upload State -->
        <div id="uploadState">
            <h1>pH/ORP Lab Data Entry</h1>
            <p class="subtitle">Select your experiment list CSV file to begin</p>
            
            <div style="text-align: center; padding: 40px 0;">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button class="btn btn-primary" id="uploadBtn" style="width: 100%; max-width: 400px; margin: 0 auto;">
                    üìÅ Select CSV File
                </button>
                <p style="margin-top: 20px; color: #86868b; font-size: 14px;">
                    Download master_experiment_list.csv from Google Drive to your iPad, then select it here
                </p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Loading experiments...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden error">
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>

        <!-- Step 1: Experiment Selection -->
        <div id="step1" class="hidden">
            <h1>Session Setup</h1>
            <p class="subtitle">Select which experiments you're measuring today</p>
            
            <div class="step-indicator">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
            </div>

            <div id="experimentList" class="experiment-list"></div>

            <div class="button-group">
                <button class="btn btn-primary" id="continueToFlasks" disabled>
                    Continue to Flask Selection
                </button>
            </div>
        </div>

        <!-- Step 2: Flask Selection -->
        <div id="step2" class="hidden">
            <h1>Flask Selection</h1>
            <p class="subtitle">Select which flasks to measure for each experiment</p>
            
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step active">2</div>
                <div class="step">3</div>
            </div>

            <div id="flaskSections"></div>

            <div class="button-group">
                <button class="btn btn-secondary" id="backToExperiments">Back</button>
                <button class="btn btn-primary" id="startMeasurements" disabled>
                    Start Measurements
                </button>
            </div>
        </div>

        <!-- Step 3: Measurements -->
        <div id="step3" class="hidden">
            <h1>Measurements</h1>
            <p class="subtitle">Enter pH and ORP values for selected flasks</p>
            
            <div class="step-indicator">
                <div class="step completed">1</div>
                <div class="step completed">2</div>
                <div class="step active">3</div>
            </div>

            <!-- Dual Probe Interface -->
            <div class="probe-container">
                <!-- pH Probe -->
                <div class="probe-box" id="phProbe">
                    <div class="probe-header">
                        <h3>üß™ pH Probe</h3>
                    </div>
                    
                    <div class="probe-experiment-select">
                        <label>Experiment:</label>
                        <select id="phExperimentSelect" class="experiment-dropdown">
                            <option value="">Select experiment...</option>
                        </select>
                    </div>
                    
                    <div class="progress-indicator" id="phProgress"></div>
                    
                    <div class="probe-flask-select">
                        <label>Flask:</label>
                        <select id="phFlaskSelect" class="flask-dropdown" disabled>
                            <option value="">Select flask...</option>
                        </select>
                    </div>
                    
                    <div class="value-input-box" id="phValueBox" data-probe="ph">
                        <div class="value-display" id="phValue">Tap to enter</div>
                    </div>
                    
                    <button class="btn btn-primary save-btn" id="phSaveBtn" disabled>
                        ‚úì Save & Continue
                    </button>
                </div>

                <!-- ORP Probe -->
                <div class="probe-box" id="orpProbe">
                    <div class="probe-header">
                        <h3>‚ö° ORP Probe</h3>
                    </div>
                    
                    <div class="probe-experiment-select">
                        <label>Experiment:</label>
                        <select id="orpExperimentSelect" class="experiment-dropdown">
                            <option value="">Select experiment...</option>
                        </select>
                    </div>
                    
                    <div class="progress-indicator" id="orpProgress"></div>
                    
                    <div class="probe-flask-select">
                        <label>Flask:</label>
                        <select id="orpFlaskSelect" class="flask-dropdown" disabled>
                            <option value="">Select flask...</option>
                        </select>
                    </div>
                    
                    <div class="value-input-box" id="orpValueBox" data-probe="orp">
                        <div class="value-display" id="orpValue">Tap to enter</div>
                    </div>
                    
                    <button class="btn btn-primary save-btn" id="orpSaveBtn" disabled>
                        ‚úì Save & Continue
                    </button>
                </div>
            </div>

            <!-- Number Pad (shared) -->
            <div class="number-pad hidden" id="numberPad">
                <div class="number-pad-display" id="numberPadDisplay">0</div>
                <div class="number-pad-buttons">
                    <button class="num-btn" data-value="1">1</button>
                    <button class="num-btn" data-value="2">2</button>
                    <button class="num-btn" data-value="3">3</button>
                    <button class="num-btn" data-value="4">4</button>
                    <button class="num-btn" data-value="5">5</button>
                    <button class="num-btn" data-value="6">6</button>
                    <button class="num-btn" data-value="7">7</button>
                    <button class="num-btn" data-value="8">8</button>
                    <button class="num-btn" data-value="9">9</button>
                    <button class="num-btn" data-value=".">.</button>
                    <button class="num-btn" data-value="0">0</button>
                    <button class="num-btn delete-btn" data-value="delete">‚å´</button>
                </div>
                <div class="number-pad-actions">
                    <button class="btn btn-secondary" id="cancelNumPad">Cancel</button>
                    <button class="btn btn-primary" id="confirmNumPad">Done</button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" id="backToFlasks">Back</button>
                <button class="btn btn-primary" id="finishSession">
                    Finish Session & Export CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let experiments = [];
        let selectedExperiments = [];
        let flaskSelections = {};
        let measurements = []; // Store all measurements for CSV export
        let currentProbe = null; // Track which probe is active
        let currentInput = ''; // Track number pad input
        
        // Progress tracking per experiment per probe
        let progressTracking = {
            ph: {}, // { 'P999_3_Kinetic Test': ['F1', 'F2'] }
            orp: {}
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Set up file upload handler
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('csvFileInput').click();
            });
            
            document.getElementById('csvFileInput').addEventListener('change', handleFileSelect);
        }

        // Handle file selection
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showError('Please select a CSV file');
                return;
            }
            
            try {
                document.getElementById('uploadState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('hidden');
                
                const csvText = await file.text();
                parseCSV(csvText);
                showStep(1);
            } catch (error) {
                showError('Failed to read file: ' + error.message);
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            
            experiments = lines.slice(1)
                .filter(line => line.trim()) // Skip empty lines
                .map(line => {
                    const values = line.split(',');
                    const exp = {
                        project: values[0],
                        ore: values[1],
                        testType: values[2],
                        flaskCount: parseInt(values[3]) || 0,
                        daysSince: parseInt(values[4]) || 999,
                        flasks: []
                    };
                    
                    // Get all flask values from remaining columns
                    for (let i = 5; i < values.length; i++) {
                        if (values[i] && values[i].trim()) {
                            exp.flasks.push(values[i].trim());
                        }
                    }
                    
                    return exp;
                });
            
            console.log('Loaded experiments:', experiments);
        }

        // Show specific step
        function showStep(step) {
            document.getElementById('uploadState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            
            if (step === 1) {
                renderExperimentList();
                document.getElementById('step1').classList.remove('hidden');
            } else if (step === 2) {
                renderFlaskSelection();
                document.getElementById('step2').classList.remove('hidden');
            } else if (step === 3) {
                initMeasurementScreen();
                document.getElementById('step3').classList.remove('hidden');
            }
        }

        // Initialize measurement screen
        function initMeasurementScreen() {
            // Populate experiment dropdowns
            const phSelect = document.getElementById('phExperimentSelect');
            const orpSelect = document.getElementById('orpExperimentSelect');
            
            phSelect.innerHTML = '<option value="">Select experiment...</option>';
            orpSelect.innerHTML = '<option value="">Select experiment...</option>';
            
            selectedExperiments.forEach((exp, index) => {
                const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
                const option = `<option value="${index}">${exp.project} - Ore ${exp.ore} - ${exp.testType}</option>`;
                phSelect.innerHTML += option;
                orpSelect.innerHTML += option;
                
                // Initialize progress tracking
                progressTracking.ph[expId] = [];
                progressTracking.orp[expId] = [];
            });
            
            // Set up event listeners
            setupMeasurementHandlers();
        }

        function setupMeasurementHandlers() {
            // Experiment selection
            document.getElementById('phExperimentSelect').addEventListener('change', (e) => {
                handleExperimentChange('ph', e.target.value);
            });
            
            document.getElementById('orpExperimentSelect').addEventListener('change', (e) => {
                handleExperimentChange('orp', e.target.value);
            });
            
            // Flask selection
            document.getElementById('phFlaskSelect').addEventListener('change', () => {
                updateSaveButtonState('ph');
            });
            
            document.getElementById('orpFlaskSelect').addEventListener('change', () => {
                updateSaveButtonState('orp');
            });
            
            // Value input boxes
            document.getElementById('phValueBox').addEventListener('click', () => {
                openNumberPad('ph');
            });
            
            document.getElementById('orpValueBox').addEventListener('click', () => {
                openNumberPad('orp');
            });
            
            // Save buttons
            document.getElementById('phSaveBtn').addEventListener('click', () => {
                saveMeasurement('ph');
            });
            
            document.getElementById('orpSaveBtn').addEventListener('click', () => {
                saveMeasurement('orp');
            });
            
            // Number pad
            document.querySelectorAll('.num-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleNumberPadInput(e.target.dataset.value);
                });
            });
            
            document.getElementById('cancelNumPad').addEventListener('click', closeNumberPad);
            document.getElementById('confirmNumPad').addEventListener('click', confirmNumberPadValue);
        }

        function handleExperimentChange(probe, expIndex) {
            if (!expIndex) {
                document.getElementById(`${probe}FlaskSelect`).disabled = true;
                document.getElementById(`${probe}FlaskSelect`).innerHTML = '<option value="">Select flask...</option>';
                updateProgressIndicator(probe, null);
                return;
            }
            
            const exp = selectedExperiments[parseInt(expIndex)];
            const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
            const flaskSelect = document.getElementById(`${probe}FlaskSelect`);
            
            // Populate flask dropdown with available flasks
            flaskSelect.innerHTML = '<option value="">Select flask...</option>';
            flaskSelections[expId].forEach(flask => {
                // Check if this flask has already been measured for this probe/experiment
                const alreadyMeasured = progressTracking[probe][expId].includes(flask);
                if (!alreadyMeasured) {
                    flaskSelect.innerHTML += `<option value="${flask}">${flask}</option>`;
                }
            });
            
            flaskSelect.disabled = false;
            
            // Update progress indicator
            updateProgressIndicator(probe, exp);
        }

        function updateProgressIndicator(probe, exp) {
            const progressDiv = document.getElementById(`${probe}Progress`);
            
            if (!exp) {
                progressDiv.innerHTML = '';
                return;
            }
            
            const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
            const availableFlasks = flaskSelections[expId];
            const completedFlasks = progressTracking[probe][expId];
            
            progressDiv.innerHTML = availableFlasks.map(flask => {
                const isCompleted = completedFlasks.includes(flask);
                const flaskNum = flask.replace(/\D/g, ''); // Extract number
                return `<div class="progress-dot ${isCompleted ? 'completed' : ''}" title="${flask}">${flaskNum || '?'}</div>`;
            }).join('');
        }

        function updateSaveButtonState(probe) {
            const expSelect = document.getElementById(`${probe}ExperimentSelect`);
            const flaskSelect = document.getElementById(`${probe}FlaskSelect`);
            const valueBox = document.getElementById(`${probe}Value`);
            const saveBtn = document.getElementById(`${probe}SaveBtn`);
            
            const hasExperiment = expSelect.value !== '';
            const hasFlask = flaskSelect.value !== '';
            const hasValue = valueBox.textContent !== 'Tap to enter' && valueBox.textContent !== '';
            
            saveBtn.disabled = !(hasExperiment && hasFlask && hasValue);
        }

        // Number pad functions
        function openNumberPad(probe) {
            const expSelect = document.getElementById(`${probe}ExperimentSelect`);
            const flaskSelect = document.getElementById(`${probe}FlaskSelect`);
            
            if (!expSelect.value || !flaskSelect.value) {
                return; // Can't enter value without experiment and flask selected
            }
            
            currentProbe = probe;
            currentInput = '';
            
            // Highlight active probe box
            document.getElementById('phProbe').classList.remove('active');
            document.getElementById('orpProbe').classList.remove('active');
            document.getElementById(`${probe}Probe`).classList.add('active');
            
            document.getElementById('phValueBox').classList.remove('active');
            document.getElementById('orpValueBox').classList.remove('active');
            document.getElementById(`${probe}ValueBox`).classList.add('active');
            
            document.getElementById('numberPadDisplay').textContent = '0';
            document.getElementById('numberPad').classList.remove('hidden');
        }

        function closeNumberPad() {
            document.getElementById('numberPad').classList.add('hidden');
            document.getElementById('phProbe').classList.remove('active');
            document.getElementById('orpProbe').classList.remove('active');
            document.getElementById('phValueBox').classList.remove('active');
            document.getElementById('orpValueBox').classList.remove('active');
            currentProbe = null;
        }

        function handleNumberPadInput(value) {
            if (value === 'delete') {
                currentInput = currentInput.slice(0, -1);
            } else if (value === '.') {
                if (!currentInput.includes('.')) {
                    currentInput += '.';
                }
            } else {
                currentInput += value;
            }
            
            document.getElementById('numberPadDisplay').textContent = currentInput || '0';
        }

        function confirmNumberPadValue() {
            if (!currentInput) return;
            
            const valueDisplay = document.getElementById(`${currentProbe}Value`);
            valueDisplay.textContent = currentInput;
            valueDisplay.classList.remove('placeholder');
            
            updateSaveButtonState(currentProbe);
            closeNumberPad();
        }

        function saveMeasurement(probe) {
            const expSelect = document.getElementById(`${probe}ExperimentSelect`);
            const flaskSelect = document.getElementById(`${probe}FlaskSelect`);
            const valueDisplay = document.getElementById(`${probe}Value`);
            
            const expIndex = parseInt(expSelect.value);
            const exp = selectedExperiments[expIndex];
            const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
            const flask = flaskSelect.value;
            const value = valueDisplay.textContent;
            
            // Create measurement record
            const measurement = {
                timestamp: new Date().toISOString(),
                project: exp.project,
                ore: exp.ore,
                testType: exp.testType,
                flask: flask,
                probe: probe.toUpperCase(),
                value: parseFloat(value)
            };
            
            measurements.push(measurement);
            console.log('Saved measurement:', measurement);
            
            // Mark flask as completed
            progressTracking[probe][expId].push(flask);
            
            // Clear value and flask selection BUT keep dropdown enabled
            valueDisplay.textContent = 'Tap to enter';
            valueDisplay.classList.add('placeholder');
            flaskSelect.value = '';
            
            // Update UI
            updateProgressIndicator(probe, exp);
            handleExperimentChange(probe, expIndex); // Refresh available flasks - this will re-enable dropdown
            updateSaveButtonState(probe);
            
            // Show feedback
            const saveBtn = document.getElementById(`${probe}SaveBtn`);
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '‚úì Saved!';
            saveBtn.style.background = '#34c759';
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 1000);
        }

        // Render experiment selection list
        function renderExperimentList() {
            const container = document.getElementById('experimentList');
            container.innerHTML = '';
            
            experiments.forEach((exp, index) => {
                const item = document.createElement('div');
                item.className = 'experiment-item';
                item.innerHTML = `
                    <div class="experiment-checkbox"></div>
                    <div class="experiment-details">
                        <div class="experiment-name">
                            ${exp.project} - Ore ${exp.ore} - ${exp.testType}
                        </div>
                        <div class="experiment-meta">
                            ${exp.flaskCount} flasks ‚Ä¢ Measured ${exp.daysSince} days ago
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => toggleExperiment(index, item));
                container.appendChild(item);
            });
        }

        // Toggle experiment selection
        function toggleExperiment(index, element) {
            const exp = experiments[index];
            const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
            
            const selectedIndex = selectedExperiments.findIndex(e => 
                `${e.project}_${e.ore}_${e.testType}` === expId
            );
            
            if (selectedIndex >= 0) {
                selectedExperiments.splice(selectedIndex, 1);
                element.classList.remove('selected');
            } else {
                selectedExperiments.push(exp);
                element.classList.add('selected');
            }
            
            document.getElementById('continueToFlasks').disabled = selectedExperiments.length === 0;
        }

        // Render flask selection
        function renderFlaskSelection() {
            const container = document.getElementById('flaskSections');
            container.innerHTML = '';
            
            selectedExperiments.forEach(exp => {
                const expId = `${exp.project}_${exp.ore}_${exp.testType}`;
                
                const section = document.createElement('div');
                section.className = 'flask-section';
                
                const title = document.createElement('div');
                title.className = 'flask-section-title';
                title.textContent = `${exp.project} - Ore ${exp.ore} - ${exp.testType}`;
                section.appendChild(title);
                
                // Select All button
                const selectAllBtn = document.createElement('button');
                selectAllBtn.className = 'select-all-btn';
                selectAllBtn.textContent = 'Select All Flasks';
                selectAllBtn.addEventListener('click', () => selectAllFlasks(expId, exp.flasks));
                section.appendChild(selectAllBtn);
                
                const grid = document.createElement('div');
                grid.className = 'flask-grid';
                grid.id = `flask-grid-${expId}`;
                
                exp.flasks.forEach(flask => {
                    const flaskItem = document.createElement('div');
                    flaskItem.className = 'flask-item';
                    flaskItem.textContent = flask;
                    flaskItem.dataset.flask = flask;
                    flaskItem.dataset.expId = expId;
                    
                    flaskItem.addEventListener('click', () => toggleFlask(expId, flask, flaskItem));
                    grid.appendChild(flaskItem);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // Toggle flask selection
        function toggleFlask(expId, flask, element) {
            if (!flaskSelections[expId]) {
                flaskSelections[expId] = [];
            }
            
            const index = flaskSelections[expId].indexOf(flask);
            if (index >= 0) {
                flaskSelections[expId].splice(index, 1);
                element.classList.remove('selected');
            } else {
                flaskSelections[expId].push(flask);
                element.classList.add('selected');
            }
            
            updateStartButton();
        }

        // Select all flasks for an experiment
        function selectAllFlasks(expId, flasks) {
            flaskSelections[expId] = [...flasks];
            
            const grid = document.getElementById(`flask-grid-${expId}`);
            Array.from(grid.children).forEach(item => {
                item.classList.add('selected');
            });
            
            updateStartButton();
        }

        // Update start button state
        function updateStartButton() {
            const hasSelections = Object.values(flaskSelections).some(arr => arr.length > 0);
            document.getElementById('startMeasurements').disabled = !hasSelections;
        }

        // Show error
        function showError(message) {
            document.getElementById('uploadState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
            
            // Show upload button again after error
            setTimeout(() => {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('uploadState').classList.remove('hidden');
            }, 3000);
        }

        // Button handlers
        document.getElementById('continueToFlasks').addEventListener('click', () => showStep(2));
        document.getElementById('backToExperiments').addEventListener('click', () => showStep(1));
        document.getElementById('startMeasurements').addEventListener('click', () => {
            console.log('Selected experiments:', selectedExperiments);
            console.log('Flask selections:', flaskSelections);
            showStep(3);
        });
        document.getElementById('backToFlasks').addEventListener('click', () => showStep(2));
        document.getElementById('finishSession').addEventListener('click', exportToCSV);

        // Export measurements to CSV
        function exportToCSV() {
            if (measurements.length === 0) {
                alert('No measurements to export!');
                return;
            }
            
            // Group measurements by experiment/flask for proper CSV format
            const csvData = {};
            
            measurements.forEach(m => {
                const key = `${m.project}_${m.ore}_${m.testType}_${m.flask}`;
                
                if (!csvData[key]) {
                    csvData[key] = {
                        Timestamp: m.timestamp,
                        'Test Type': m.testType,
                        Project: m.project,
                        Ore: m.ore,
                        'WT pH': '',
                        'KT pH': '',
                        'AT pH': '',
                        'BT pH': '',
                        'KT Volume Acid Added': '',
                        'KT pH Adjusted': '',
                        'WT Flask Number': '',
                        'KT Flask Number': '',
                        'AT Flask Number': '',
                        'BT Flask Number': '',
                        'WT ORP': '',
                        'KT ORP': '',
                        'AT ORP': '',
                        'BT ORP': ''
                    };
                }
                
                // Map probe and test type to correct columns
                const testPrefix = m.testType.includes('Water') ? 'WT' : 
                                 m.testType.includes('Kinetic') ? 'KT' :
                                 m.testType.includes('Acid') ? 'AT' : 'BT';
                
                if (m.probe === 'PH') {
                    csvData[key][`${testPrefix} pH`] = m.value;
                    csvData[key][`${testPrefix} Flask Number`] = m.flask;
                } else if (m.probe === 'ORP') {
                    csvData[key][`${testPrefix} ORP`] = m.value;
                    if (!csvData[key][`${testPrefix} Flask Number`]) {
                        csvData[key][`${testPrefix} Flask Number`] = m.flask;
                    }
                }
            });
            
            // Convert to CSV format
            const headers = ['Timestamp', 'Test Type', 'WT pH', 'KT pH', 'AT pH', 'BT pH', 
                           'KT Volume Acid Added', 'KT pH Adjusted', 'Project', 'Ore',
                           'KT Flask Number', 'AT Flask Number', 'WT Flask Number', 'BT Flask Number',
                           'KT ORP', 'AT ORP', 'WT ORP', 'BT ORP'];
            
            let csvContent = headers.join(',') + '\n';
            
            Object.values(csvData).forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // Escape commas and quotes in values
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            link.setAttribute('href', url);
            link.setAttribute('download', `pH_ORP_data_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('Exported measurements:', measurements.length);
            
            // iPad-specific download instructions
            const fileName = `pH_ORP_data_${timestamp}.csv`;
            alert(`‚úì Successfully exported ${measurements.length} measurements!\n\n` +
                  `File: ${fileName}\n\n` +
                  `üì± On iPad, the file was saved to:\n` +
                  `Files app ‚Üí On My iPad ‚Üí Downloads\n` +
                  `(or iCloud Drive ‚Üí Downloads)\n\n` +
                  `Next steps:\n` +
                  `1. Open Files app\n` +
                  `2. Find ${fileName} in Downloads\n` +
                  `3. Upload to your Google Drive folder\n` +
                  `4. Your Apps Script will auto-import it!`);
        }
    </script>
</body>
</html>
